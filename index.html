<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>住居表示住所</title>
  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-hash@0.2.1/leaflet-hash.js"></script>
  <style>
    .my-div-icon {
      font-size: 9pt;
      white-space: nowrap;
      font-weight: bold;
      color: black;
      background: orange;
      border: 1px solid black;
      width: auto !important;
      height: auto !important;
    }
  </style>
</head>

<body>
  <div id="map" style="position:absolute;top:0;left:0;bottom:0;right:0;"></div>
  <script>
    var map = L.map("map", L.extend({
      zoom: 19,
      maxZoom: 20,
      center: [35.64430, 139.67124]
    }, L.Hash.parseHash(location.hash)));
    map.zoomControl.setPosition("bottomright");

    L.hash(map);

    L.tileLayer("https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg", {
      attribution: "<a href='http://maps.gsi.go.jp/development/ichiran.html'>地理院タイル</a>",
      maxNativeZoom: 18,
      maxZoom: 20
    }).addTo(map);

    L.tileLayer(L.Util.emptyImageUrl, {
      maxNativeZoom: 18,
      minNativeZoom: 18
    }).on("loading", function(event) {
      this.promises = [];
      if (!this.layers) this.layers = [];
    }).on("tileload", function(event) {
      var url = L.Util.template("https://cyberjapandata.gsi.go.jp/xyz/experimental_jhj/{z}/{x}/{y}.geojson", event.coords);
      this.promises.push(fetch(url).then(a => a.ok ? a.json() : {
        features: []
      }).then(json => {
        event.tile.json = json;
      }));
    }).on("load", function(event) {
      var that = this;
      Promise.all(this.promises).then(a => {
        while (that.layers.length > 0)
          map.removeLayer(that.layers.pop());
        var data = {};
        Object.values(that._tiles).forEach(b => {
          try {
            b.el.json.features.forEach(f => {
              var key = f.properties["市区町村コード"] + ":" +
                f.properties["町又は字の名称"] + "-" +
                f.properties["街区符号"];
              if (!data[key]) data[key] = [f];
              else data[key].push(f);
            });
          } catch (e) {}
        });
        Object.keys(data).forEach(key => {
          data[key].sort(function(s, t) {
            return parseInt(s.properties["基礎番号"]) - parseInt(t.properties["基礎番号"]);
          });
          var points = data[key].map(f => {
            return [f.geometry.coordinates[1], f.geometry.coordinates[0]];
          });
          var polygon = L.polygon(points).addTo(map);
          that.layers.push(polygon);
          var caption = L.marker(polygon.getBounds().getCenter(), {
            icon: L.divIcon({
              className: 'my-div-icon',
              html: key
            })
          }).addTo(map);
          that.layers.push(caption);
        });
      });
    }).addTo(map);
  </script>
</body>

</html>
